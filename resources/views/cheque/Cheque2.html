<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏ä‡πá‡∏Ñ Pro</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    
    <!-- jQuery (required for DataTables) -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
</head>
<body>
    <div class="main-container">
        <div class="sidebar">
            <div class="header">
                <h2>üè¶ ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏ä‡πá‡∏Ñ Pro</h2>
            </div>

            <!-- Section: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏•‡∏≠‡∏î) -->
            <div class="menu-section input-section">
                <div class="menu-header">
                    <span>üìù ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡πá‡∏Ñ</span>
                </div>
                <div class="menu-content active" id="inputContent">
                    <div class="menu-body">
                        <div class="control-group">
                            <label>üè¢ ‡∏™‡∏≤‡∏Ç‡∏≤</label>
                            <select id="branchInput">
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ --</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label>üìã ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</label>
                            <select id="bankSelect" onchange="loadBankTemplate()">
                                <option value="custom">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</option>
                                <option value="scb">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå (SCB)</option>
                                <option value="kbank">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢ (KBANK)</option>
                                <option value="ktb">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢ (KTB)</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label>üî¢ ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÄ‡∏ä‡πá‡∏Ñ</label>
                            <input type="text" id="chequeNumber" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1510258">
                            <button type="button" onclick="useNextChequeNo()">‡πÄ‡∏•‡∏Ç‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
                        </div>

                        <div class="control-group">
                            <label>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                            <input type="date" id="dateInput">
                        </div>

                        <div class="control-group">
                            <label>üë§ ‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏´‡πâ</label>
                            <input type="text" id="payeeInput" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô" autocomplete="off">
                            <div id="autocomplete-list" class="autocomplete-items"></div>
                        </div>

                        <div class="control-group">
                            <label>üí∞ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                            <input type="text" id="amountInput" placeholder="0.00">
                        </div>

                        <div class="control-group">
                            <label>
                                <input type="checkbox" id="showAcPayee" checked>
                                ‡πÅ‡∏™‡∏î‡∏á A/C PAYEE ONLY
                            </label>
                        </div>

                        <div class="control-group">
                            <label>
                                <input type="checkbox" id="showLine" checked>
                                ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡πâ‡∏ô (‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠)
                            </label>
                        </div>

                        <button class="btn-primary" onclick="printCheque()" style="width: 100%;">
                            üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏ä‡πá‡∏Ñ
                        </button>
                        <button class="btn-info" onclick="clearForm()" style="width: 100%;">
                            üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
                        </button>
                    </div>
                </div>
            </div>

            <!-- Section: ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö -->
            <div class="menu-section">
                <div class="menu-header" id="designHeader" onclick="toggleMenu('design')">
                    <span>üé® ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö & ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á</span>
                    <span class="menu-icon">‚ñº</span>
                </div>
                <div class="menu-content" id="designContent">
                    <div class="menu-body">
                        <div class="property-panel">
                            <h3>üìê ‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©</h3>
                            <div class="control-group">
                                <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏ô‡∏≤‡∏î</label>
                                <select id="paperSize" onchange="changePaperSize()">
                                    <option value="800x350">‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô (800x350px)</option>
                                    <option value="750x320">‡πÄ‡∏•‡πá‡∏Å (750x320px)</option>
                                    <option value="850x380">‡πÉ‡∏´‡∏ç‡πà (850x380px)</option>
                                    <option value="custom">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</option>
                                </select>
                            </div>
                            <div id="customSizePanel" style="display:none;">
                                <div class="two-column">
                                    <div class="control-group">
                                        <label>‡∏Å‡∏ß‡πâ‡∏≤‡∏á (px)</label>
                                        <input type="number" id="customWidth" value="800">
                                    </div>
                                    <div class="control-group">
                                        <label>‡∏™‡∏π‡∏á (px)</label>
                                        <input type="number" id="customHeight" value="350">
                                    </div>
                                </div>
                                <button class="btn-secondary" onclick="applyCustomSize()" style="width:100%;">
                                    ‚úì ‡πÉ‡∏ä‡πâ‡∏Ç‡∏ô‡∏≤‡∏î‡∏ô‡∏µ‡πâ
                                </button>
                            </div>
                        </div>

                        <div class="property-panel" id="elementProperties" style="display:none;">
                            <h3>‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: <span id="selectedElementName">-</span></h3>
                            
                            <div class="two-column">
                                <div class="control-group">
                                    <label>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á X</label>
                                    <input type="number" id="propX" onchange="updateElementProperty()">
                                </div>
                                <div class="control-group">
                                    <label>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á Y</label>
                                    <input type="number" id="propY" onchange="updateElementProperty()">
                                </div>
                            </div>

                            <div class="control-group">
                                <label>‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ (px)</label>
                                <input type="number" id="propFontSize" onchange="updateElementProperty()" min="10" max="50">
                            </div>

                            <div class="control-group">
                                <label>‡∏™‡∏µ</label>
                                <input type="color" id="propColor" onchange="updateElementProperty()">
                            </div>

                            <div class="control-group">
                                <label>
                                    <input type="checkbox" id="propBold" onchange="updateElementProperty()">
                                    ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏≤
                                </label>
                            </div>
                        </div>

                        <button class="btn-warning" onclick="saveAsTemplate()" style="width:100%;">
                            üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Template
                        </button>
                        <button class="btn-danger" onclick="resetPositions()" style="width:100%;">
                            üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
                        </button>
                    </div>
                </div>
            </div>

            <!-- Section: ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô -->
            <div class="menu-section">
                <div class="menu-header" id="reportHeader" onclick="toggleMenu('report')">
                    <span>üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</span>
                </div>
            </div>

            <!-- Section: ‡∏™‡∏≤‡∏Ç‡∏≤ -->
            <div class="menu-section">
                <div class="menu-header" id="branchHeader" onclick="toggleMenu('branch')">
                    <span>üè¢ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏Ç‡∏≤</span>
                </div>    
            </div>

            <!-- Section: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ -->
            <div class="menu-section">
                <div class="menu-header" id="settingsHeader" onclick="toggleMenu('settings')">
                    <span>‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</span>
                </div>
            </div>
        </div>

        <div class="content">
            <div class="cheque-workspace" id="chequeWorkspace">
                <div class="info-section">
                    <div class="info-badge">üí° ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</div>
                    <div class="info-badge">üñ±Ô∏è ‡∏•‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡πâ‡∏≤‡∏¢‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</div>
                </div>
                
                <div class="cheque-preview" id="chequePreview">
                    <div class="draggable ac-payee" id="acPayee" data-name="A/C PAYEE ONLY">
                        A/C PAYEE ONLY
                    </div>
                    <div class="draggable line-holder" id="lineHolder" data-name="‡πÄ‡∏™‡πâ‡∏ô (‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠)">
                        --------
                    </div>
                    <div class="draggable date-container" id="dateDisplay" data-name="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"></div>
                    <div class="draggable" id="payeeDisplay" data-name="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô">
                        &lt;‡∏™‡∏±‡πà‡∏á‡∏à‡πà‡∏≤‡∏¢&gt;
                    </div>
                    <div class="draggable" id="amountText" data-name="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)"></div>
                    <div class="draggable" id="amountNumber" data-name="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)">
                        ***0.00***
                    </div>
                </div>
            </div>
            <!-- ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô -->
            <div id="reportWorkspace" style="display:none;">
                <div style="background: white; border-radius: 10px; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <h2 style="margin-bottom: 20px;">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏ä‡πá‡∏Ñ</h2>
                    <div id="reportContainer2">
                        <div class="no-data">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
                    </div>
                </div>
            </div>

            <!-- ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏Ç‡∏≤ -->
            <div id="branchWorkspace" style="display:none;">
                <div style="background: white; border-radius: 10px; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <button class="btn-secondary" onclick="backToCheque()" style="margin-bottom: 20px;">
                        ‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏ä‡πá‡∏Ñ
                    </button>
                    <h2 style="margin-bottom: 20px;">üè¢ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏Ç‡∏≤</h2>
                    <div id="branchMainContent">
                        <div class="control-group">
                            <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label>
                            <select id="currentBranch2" onchange="changeBranch2()">
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ --</option>
                            </select>
                        </div>

                        <div class="property-panel">
                            <h3>‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤‡πÉ‡∏´‡∏°‡πà</h3>
                            <div class="control-group">
                                <label>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤</label>
                                <input type="text" id="newBranchCode2" placeholder="‡πÄ‡∏ä‡πà‡∏ô BKK01">
                            </div>
                            <div class="control-group">
                                <label>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤</label>
                                <input type="text" id="newBranchName2" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà">
                            </div>
                            <button class="btn-primary" onclick="addBranch2()" style="width:100%;">
                                ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤
                            </button>
                        </div>

                        <div class="property-panel">
                            <h3>üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                            <div id="branchList2" style="max-height: 400px; overflow-y: auto;">
                                <div class="no-data">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏≤‡∏Ç‡∏≤</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö -->
            <div id="settingsWorkspace" style="display:none;">
                <div style="background: white; border-radius: 10px; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <button class="btn-secondary" onclick="backToCheque()" style="margin-bottom: 20px;">
                        ‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏ä‡πá‡∏Ñ
                    </button>
                    <h2 style="margin-bottom: 20px;">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h2>
                    <div id="settingsMainContent">
                        <div class="property-panel">
                            <h3>üì§ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                            <button class="btn-secondary" onclick="exportAllData()" style="width:100%; margin-bottom:10px;">
                                üíæ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                            </button>
                            <button class="btn-secondary" onclick="exportLayoutOnly()" style="width:100%; margin-bottom:10px;">
                                üé® ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Layout
                            </button>
                            <button class="btn-secondary" onclick="exportRecordsOnly()" style="width:100%;">
                                üìä ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡πá‡∏Ñ
                            </button>
                        </div>

                        <div class="property-panel">
                            <h3>üì• ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                            <input type="file" id="importFile2" accept=".json" style="display:none;" onchange="handleImport(this.files[0])">
                            <button class="btn-warning" onclick="document.getElementById('importFile2').click()" style="width:100%;">
                                üìÇ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤
                            </button>
                            <div style="background: #fff3cd; padding: 10px; border-radius: 5px; font-size: 12px; margin-top: 10px;">
                                ‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏∞‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°!
                            </div>
                        </div>

                        <div class="property-panel">
                            <h3>üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                            <button class="btn-danger" onclick="clearAllData()" style="width:100%; margin-bottom:10px;">
                                üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                            </button>
                            <button class="btn-danger" onclick="clearRecordsOnly()" style="width:100%;">
                                üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡πá‡∏Ñ
                            </button>
                        </div>

                        <div class="property-panel">
                            <h3>‚ÑπÔ∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h3>
                            <div style="font-size: 13px; line-height: 1.8;">
                                <p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ:</strong> <span id="totalCheques2">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                                <p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤:</strong> <span id="totalBranches2">0</span> ‡∏™‡∏≤‡∏Ç‡∏≤</p>
                                <p><strong>Template:</strong> <span id="totalTemplates2">0</span> ‡πÅ‡∏ö‡∏ö</p>
                                <p><strong>‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:</strong> <span id="dataSize2">0</span> KB</p>
                            </div>
                            <button class="btn-secondary" onclick="updateSystemInfo2()" style="width:100%; margin-top:10px;">
                                üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
                            </button>
                            <button class="btn-info" onclick="checkDbConnection()" style="width:100%; margin-top:10px;">
                                ü©∫ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== API BASE URL ====================
        // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å base URL ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥: ‡∏ñ‡πâ‡∏≤ hostname ‡∏°‡∏µ bot.ekapab.work ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ /api, ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ localhost
        const API_BASE = (window.location.hostname === 'bot.ekapab.work') ? '/api' : 'http://localhost:5500';

        // ==================== ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ====================
        async function checkDbConnection() {
            try {
                // ‡∏•‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API /branches (‡∏´‡∏£‡∏∑‡∏≠ /cheques ‡∏Å‡πá‡πÑ‡∏î‡πâ)
                const res = await fetch(`${API_BASE}/branches`);
                if (!res.ok) throw new Error('API error');
                const data = await res.json();
                Swal.fire({
                    icon: 'success',
                    title: '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                    text: `‡∏û‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤ ${data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`,
                    confirmButtonColor: '#4CAF50'
                });
            } catch (e) {
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡∏´‡∏£‡∏∑‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ',
                    confirmButtonColor: '#f44336'
                });
            }
        }
        
        let selectedElement = null;
        let draggedElement = null;
        let offsetX = 0;
        let offsetY = 0;

        const defaultPositions = {
            acPayee: { top: 40, left: 200, fontSize: 18, color: '#ff0000', bold: true },
            lineHolder: { top: 85, left: 80, fontSize: 20, color: '#000000', bold: true },
            dateDisplay: { top: 40, right: 90, fontSize: 20, color: '#000000', bold: false },
            payeeDisplay: { top: 110, left: 80, fontSize: 18, color: '#000000', bold: false },
            amountText: { top: 165, left: 80, fontSize: 16, color: '#000000', bold: false },
            amountNumber: { top: 215, right: 90, fontSize: 18, color: '#000000', bold: true }
        };

        const bankTemplates = {
            scb: {
                acPayee: { top: 35, left: 200, fontSize: 18, color: '#ff0000', bold: true },
                lineHolder: { top: 80, left: 75, fontSize: 20, color: '#000000', bold: true },
                dateDisplay: { top: 35, right: 85, fontSize: 20, color: '#000000', bold: false },
                payeeDisplay: { top: 105, left: 75, fontSize: 18, color: '#000000', bold: false },
                amountText: { top: 160, left: 75, fontSize: 16, color: '#000000', bold: false },
                amountNumber: { top: 210, right: 85, fontSize: 18, color: '#000000', bold: true }
            },
            kbank: {
                acPayee: { top: 45, left: 210, fontSize: 18, color: '#ff0000', bold: true },
                lineHolder: { top: 90, left: 85, fontSize: 20, color: '#000000', bold: true },
                dateDisplay: { top: 45, right: 95, fontSize: 20, color: '#000000', bold: false },
                payeeDisplay: { top: 115, left: 85, fontSize: 18, color: '#000000', bold: false },
                amountText: { top: 170, left: 85, fontSize: 16, color: '#000000', bold: false },
                amountNumber: { top: 220, right: 95, fontSize: 18, color: '#000000', bold: true }
            },
            ktb: {
                acPayee: { top: 38, left: 205, fontSize: 18, color: '#ff0000', bold: true },
                lineHolder: { top: 83, left: 78, fontSize: 20, color: '#000000', bold: true },
                dateDisplay: { top: 38, right: 88, fontSize: 20, color: '#000000', bold: false },
                payeeDisplay: { top: 108, left: 78, fontSize: 18, color: '#000000', bold: false },
                amountText: { top: 163, left: 78, fontSize: 16, color: '#000000', bold: false },
                amountNumber: { top: 213, right: 88, fontSize: 18, color: '#000000', bold: true }
            }
        };

        const thaiNumbers = ['‡∏®‡∏π‡∏ô‡∏¢‡πå', '‡∏´‡∏ô‡∏∂‡πà‡∏á', '‡∏™‡∏≠‡∏á', '‡∏™‡∏≤‡∏°', '‡∏™‡∏µ‡πà', '‡∏´‡πâ‡∏≤', '‡∏´‡∏Å', '‡πÄ‡∏à‡πá‡∏î', '‡πÅ‡∏õ‡∏î', '‡πÄ‡∏Å‡πâ‡∏≤'];
        const thaiUnits = ['', '‡∏™‡∏¥‡∏ö', '‡∏£‡πâ‡∏≠‡∏¢', '‡∏û‡∏±‡∏ô', '‡∏´‡∏°‡∏∑‡πà‡∏ô', '‡πÅ‡∏™‡∏ô', '‡∏•‡πâ‡∏≤‡∏ô'];

        function numberToThaiText(num) {
            if (num === 0) return '‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ö‡∏≤‡∏ó‡∏ñ‡πâ‡∏ß‡∏ô';
            const parts = num.toFixed(2).split('.');
            let baht = parseInt(parts[0]);
            let satang = parseInt(parts[1]);
            let result = '';
            if (baht > 0) {
                result = convertIntegerToThai(baht) + '‡∏ö‡∏≤‡∏ó';
            }
            if (satang > 0) {
                result += convertIntegerToThai(satang) + '‡∏™‡∏ï‡∏≤‡∏á‡∏Ñ‡πå';
            } else {
                result += '‡∏ñ‡πâ‡∏ß‡∏ô';
            }
            return result;
        }

        function convertIntegerToThai(num) {
            if (num === 0) return '';
            const str = num.toString();
            const len = str.length;
            let result = '';
            for (let i = 0; i < len; i++) {
                const digit = parseInt(str[i]);
                const position = len - i - 1;
                if (digit === 0) continue;
                if (position === 1 && digit === 1) {
                    result += '‡∏™‡∏¥‡∏ö';
                } else if (position === 1 && digit === 2) {
                    result += '‡∏¢‡∏µ‡πà‡∏™‡∏¥‡∏ö';
                } else if (position === 0 && digit === 1 && len > 1) {
                    result += '‡πÄ‡∏≠‡πá‡∏î';
                } else {
                    result += thaiNumbers[digit] + thaiUnits[position];
                }
            }
            return result;
        }

        const fmtBaht = new Intl.NumberFormat('th-TH', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
        });

        function parseAmount(str) {
            // ‡∏Å‡∏±‡∏ô‡πÄ‡∏Ñ‡∏™‡∏°‡∏µ , ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏≠‡∏∑‡πà‡∏ô ‡πÜ
            const n = Number((str ?? '').toString().replace(/[^\d.-]/g, ''));
            return isNaN(n) ? 0 : n;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Date object ‡∏Å‡πà‡∏≠‡∏ô
            const date = new Date(dateStr);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}${month}${year}`;
        }

        function formatDateDisplay(dateStr) {
            if (!dateStr) return '';
            // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Date object ‡∏Å‡πà‡∏≠‡∏ô
            const date = new Date(dateStr);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function displayDateWithSpaces(dateStr) {
            const formatted = formatDate(dateStr); // ‡πÄ‡∏ä‡πà‡∏ô "DDMMYYYY"
            const container = document.getElementById('dateDisplay');
            container.innerHTML = '';

            for (let i = 0; i < formatted.length; i++) {
                const span = document.createElement('span');
                span.className = 'date-digit';
                span.textContent = formatted[i];
                container.appendChild(span);

                // ‡πÄ‡∏û‡∏¥‡πà‡∏° "‡∏ß‡∏£‡∏£‡∏Ñ" (‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á) ‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏±‡∏ß (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏ï‡∏±‡∏ß‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢)
                if (i < formatted.length - 1) {
                const space = document.createElement('span');
                space.className = 'date-space';
                space.textContent = ' ';
                container.appendChild(space);

                // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å ‚Äú‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏£‡∏£‡∏Ñ‡πÑ‡∏õ‡∏≠‡∏µ‡∏Å‡∏≠‡∏±‡∏ô‚Äù ‡∏Å‡πá‡πÅ‡∏ó‡∏£‡∏Å‡∏ã‡πâ‡∏≥‡∏≠‡∏µ‡∏Å‡∏≠‡∏±‡∏ô
                const extra = document.createElement('span');
                extra.className = 'date-space';
                extra.textContent = ' ';
                container.appendChild(extra);
                }
            }
        }

        // function switchTab(tab) {
        //     document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        //     document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
        //     const chequeWork = document.getElementById('chequeWorkspace') || document.querySelector('.cheque-workspace');
        //     const reportWork = document.getElementById('reportWorkspace');
            
        //     if (tab === 'input') {
        //         document.querySelectorAll('.tab')[0].classList.add('active');
        //         document.getElementById('inputTab').classList.add('active');
        //         if (chequeWork) chequeWork.style.display = 'block';
        //         if (reportWork) reportWork.style.display = 'none';
        //     } else if (tab === 'design') {
        //         document.querySelectorAll('.tab')[1].classList.add('active');
        //         document.getElementById('designTab').classList.add('active');
        //         if (chequeWork) chequeWork.style.display = 'block';
        //         if (reportWork) reportWork.style.display = 'none';
        //     } else if (tab === 'report') {
        //         document.querySelectorAll('.tab')[2].classList.add('active');
        //         document.getElementById('reportTab').classList.add('active');
        //         if (chequeWork) chequeWork.style.display = 'none';
        //         if (reportWork) {
        //             reportWork.style.display = 'block';
        //             loadReportWithWeekly();
        //         }
        //     } else if (tab === 'branch') {
        //         document.querySelectorAll('.tab')[3].classList.add('active');
        //         document.getElementById('branchTab').classList.add('active');
        //         if (chequeWork) chequeWork.style.display = 'none';
        //         if (reportWork) reportWork.style.display = 'none';
        //         loadBranches();
        //     } else if (tab === 'settings') {
        //         document.querySelectorAll('.tab')[4].classList.add('active');
        //         document.getElementById('settingsTab').classList.add('active');
        //         if (chequeWork) chequeWork.style.display = 'none';
        //         if (reportWork) reportWork.style.display = 'none';
        //         updateSystemInfo();
        //     }
        // }

        async function loadReportLarge() {
            const container = document.getElementById('reportContainer2') || document.getElementById('reportContainer');
            let records = [];
            try {
                const res = await fetch(`${API_BASE}/cheques`);
                records = await res.json();
            } catch (e) {
                container.innerHTML = '<div class="no-data">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ</div>';
                return;
            }
            if (records.length === 0) {
                container.innerHTML = '<div class="no-data">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏ä‡πá‡∏Ñ</div>';
                return;
            }
            let html = '<table class="report-table"><thead><tr>';
            html += '<th>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</th><th>‡πÄ‡∏•‡∏Ç‡πÄ‡∏ä‡πá‡∏Ñ</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏´‡πâ</th>';
            html += '<th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå</th>';
            html += '</tr></thead><tbody>';
            records.forEach((record) => {
                const bankName = record.bank === 'custom' ? '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á' : 
                                record.bank === 'scb' ? 'SCB' :
                                record.bank === 'kbank' ? 'KBANK' :
                                record.bank === 'ktb' ? 'KTB' : record.bank;
                html += '<tr>';
                html += `<td>${bankName}</td>`;
                html += `<td>${record.cheque_number}</td>`;
                html += `<td>${formatDateDisplay(record.date)}</td>`;
                html += `<td>${record.payee}</td>`;
                html += `<td>${fmtBaht.format(record.amount)}</td>`;
                html += `<td>${record.printed_at ? new Date(record.printed_at).toLocaleString('th-TH') : ''}</td>`;
                html += '</tr>';
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function editCheque(index) {
            const records = JSON.parse(localStorage.getItem('chequeRecords') || '[]');
            const record = records[index];
            
            document.getElementById('branchInput').value = record.branch || '';
            document.getElementById('bankSelect').value = record.bank;
            document.getElementById('chequeNumber').value = record.chequeNumber;
            document.getElementById('dateInput').value = record.date;
            document.getElementById('payeeInput').value = record.payee;
            document.getElementById('amountInput').value = record.amount.toString();
            
            displayDateWithSpaces(record.date);
            document.getElementById('payeeDisplay').textContent = record.payee;
            document.getElementById('amountText').textContent = numberToThaiText(record.amount);
            document.getElementById('amountNumber').textContent = `***${fmtBaht.format(record.amount)}***`;
            
            // ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            document.getElementById('reportContent').classList.remove('active');
            document.getElementById('reportHeader').classList.remove('active');
            switchToInput();
            
            saveData();
            
            Swal.fire({
                title: '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß!',
                text: '‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ',
                icon: 'info',
                timer: 2000,
                showConfirmButton: false
            });
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≤‡∏Å API (‡πÉ‡∏ä‡πâ ID)
        async function editChequeFromAPI(id) {
            try {
                const res = await fetch(`${API_BASE}/cheques`);
                const records = await res.json();
                const record = records.find(r => r.id === id);
                
                if (!record) {
                    Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•!', '', 'error');
                    return;
                }
                
                document.getElementById('branchInput').value = record.branch_code || '';
                document.getElementById('bankSelect').value = record.bank;
                document.getElementById('chequeNumber').value = record.cheque_number;
                document.getElementById('dateInput').value = record.date;
                document.getElementById('payeeInput').value = record.payee;
                document.getElementById('amountInput').value = record.amount.toString();
                
                displayDateWithSpaces(record.date);
                document.getElementById('payeeDisplay').textContent = record.payee;
                document.getElementById('amountText').textContent = numberToThaiText(parseFloat(record.amount));
                document.getElementById('amountNumber').textContent = `***${fmtBaht.format(parseFloat(record.amount))}***`;
                
                switchToInput();
                saveData();
                
                Swal.fire({
                    title: '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß!',
                    text: '‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ',
                    icon: 'info',
                    timer: 2000,
                    showConfirmButton: false
                });
            } catch (e) {
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≤‡∏Å API (‡πÉ‡∏ä‡πâ ID)
        async function deleteChequeFromAPI(id) {
            Swal.fire({
                title: '‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?',
                text: '‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#f44336',
                cancelButtonColor: '#999',
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡πÄ‡∏•‡∏¢',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        await fetch(`${API_BASE}/cheques/${id}`, {
                            method: 'DELETE'
                        });
                        
                        Swal.fire({
                            title: '‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß!',
                            text: '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢',
                            icon: 'success',
                            timer: 1500,
                            showConfirmButton: false
                        });
                        
                        // Reload ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                        await showAllRecords();
                    } catch (e) {
                        Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
                    }
                }
            });
        }

        function selectElement(element) {
            if (selectedElement) {
                selectedElement.classList.remove('selected');
            }
            selectedElement = element;
            element.classList.add('selected');
            
            document.getElementById('elementProperties').style.display = 'block';
            document.getElementById('selectedElementName').textContent = element.dataset.name;
            
            const rect = element.getBoundingClientRect();
            const parent = document.getElementById('chequePreview').getBoundingClientRect();
            
            document.getElementById('propX').value = Math.round(element.offsetLeft);
            document.getElementById('propY').value = Math.round(element.offsetTop);
            document.getElementById('propFontSize').value = parseInt(window.getComputedStyle(element).fontSize);
            document.getElementById('propColor').value = rgbToHex(window.getComputedStyle(element).color);
            document.getElementById('propBold').checked = window.getComputedStyle(element).fontWeight === 'bold' || window.getComputedStyle(element).fontWeight >= 700;
        }

        function rgbToHex(rgb) {
            const match = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
            if (!match) return '#000000';
            return '#' + [match[1], match[2], match[3]].map(x => {
                const hex = parseInt(x).toString(16);
                return hex.length === 1 ? '0' + hex : hex;
            }).join('');
        }

        function updateElementProperty() {
            if (!selectedElement) return;
            
            const x = parseInt(document.getElementById('propX').value);
            const y = parseInt(document.getElementById('propY').value);
            const fontSize = parseInt(document.getElementById('propFontSize').value);
            const color = document.getElementById('propColor').value;
            const bold = document.getElementById('propBold').checked;
            
            selectedElement.style.left = x + 'px';
            selectedElement.style.top = y + 'px';
            selectedElement.style.right = 'auto';
            selectedElement.style.fontSize = fontSize + 'px';
            selectedElement.style.color = color;
            selectedElement.style.fontWeight = bold ? 'bold' : 'normal';
            
            savePositions();
        }

        function changePaperSize() {
            const size = document.getElementById('paperSize').value;
            const preview = document.getElementById('chequePreview');
            
            if (size === 'custom') {
                document.getElementById('customSizePanel').style.display = 'block';
            } else {
                document.getElementById('customSizePanel').style.display = 'none';
                const [width, height] = size.split('x');
                preview.style.width = width + 'px';
                preview.style.height = height + 'px';
                localStorage.setItem('paperSize', size);
            }
        }

        function applyCustomSize() {
            const width = document.getElementById('customWidth').value;
            const height = document.getElementById('customHeight').value;
            const preview = document.getElementById('chequePreview');
            preview.style.width = width + 'px';
            preview.style.height = height + 'px';
            localStorage.setItem('paperSize', `${width}x${height}`);
        }

        async function loadBankTemplate() {
            const bank = document.getElementById('bankSelect').value;
            if (bank === 'custom') return;
            // ‡∏•‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å API ‡∏Å‡πà‡∏≠‡∏ô
            let template = null;
            try {
                const res = await fetch(`${API_BASE}/templates`);
                const templates = await res.json();
                const found = templates.find(t => t.bank === bank);
                if (found) template = found.template_json;
            } catch (e) {}
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡πÉ‡∏ô API fallback ‡πÄ‡∏õ‡πá‡∏ô bankTemplates ‡πÄ‡∏î‡∏¥‡∏°
            if (!template) template = bankTemplates[bank];
            if (!template) return;
            Object.keys(template).forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    const props = template[id];
                    if (props.top !== undefined) element.style.top = props.top + 'px';
                    if (props.left !== undefined) {
                        element.style.left = props.left + 'px';
                        element.style.right = 'auto';
                    }
                    if (props.right !== undefined) {
                        element.style.right = props.right + 'px';
                        element.style.left = 'auto';
                    }
                    if (props.fontSize) element.style.fontSize = props.fontSize + 'px';
                    if (props.color) element.style.color = props.color;
                    if (props.bold !== undefined) element.style.fontWeight = props.bold ? 'bold' : 'normal';
                }
            });
            savePositions();
            saveData();
        }

        async function saveAsTemplate() {
            const bank = document.getElementById('bankSelect').value;
            if (bank === 'custom') {
                Swal.fire({
                    title: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ!',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Template',
                    icon: 'error',
                    confirmButtonColor: '#f44336'
                });
                return;
            }
            
            const template = {};
            document.querySelectorAll('.draggable').forEach(el => {
                template[el.id] = {
                    top: parseInt(el.style.top),
                    left: el.style.left !== 'auto' ? parseInt(el.style.left) : undefined,
                    right: el.style.right !== 'auto' ? parseInt(el.style.right) : undefined,
                    fontSize: parseInt(el.style.fontSize),
                    color: el.style.color,
                    bold: el.style.fontWeight === 'bold'
                };
            });
            
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á localStorage (‡πÄ‡∏û‡∏∑‡πà‡∏≠ backward compatibility)
            localStorage.setItem(`template_${bank}`, JSON.stringify(template));
            
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á API
            try {
                await fetch(`${API_BASE}/templates`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bank, template_json: template })
                });
            } catch (e) {
                console.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å template ‡πÑ‡∏õ API ‡πÑ‡∏î‡πâ:', e);
            }
            
            Swal.fire({
                title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                text: 'Template ‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß',
                icon: 'success',
                confirmButtonColor: '#4CAF50'
            });
        }

        function resetPositions() {
            Swal.fire({
                title: '‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á?',
                text: '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#f44336',
                cancelButtonColor: '#999',
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then((result) => {
                if (result.isConfirmed) {
                    const bank = document.getElementById('bankSelect').value;
                    const positions = bank !== 'custom' && bankTemplates[bank] ? bankTemplates[bank] : defaultPositions;
                    
                    Object.keys(positions).forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            const props = positions[id];
                            element.style.top = props.top + 'px';
                            if (props.left !== undefined) {
                                element.style.left = props.left + 'px';
                                element.style.right = 'auto';
                            }
                            if (props.right !== undefined) {
                                element.style.right = props.right + 'px';
                                element.style.left = 'auto';
                            }
                            element.style.fontSize = props.fontSize + 'px';
                            element.style.color = props.color;
                            element.style.fontWeight = props.bold ? 'bold' : 'normal';
                        }
                    });
                    
                    localStorage.removeItem('chequePositions');
                    
                    Swal.fire({
                        title: '‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÅ‡∏•‡πâ‡∏ß!',
                        text: '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ñ‡∏π‡∏Å‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢',
                        icon: 'success',
                        timer: 1500,
                        showConfirmButton: false
                    });
                }
            });
        }

        document.querySelectorAll('.draggable').forEach(element => {
            element.addEventListener('click', function(e) {
                e.stopPropagation();
                selectElement(this);
                // ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö
                if (!document.getElementById('designContent').classList.contains('active')) {
                    toggleMenu('design');
                }
            });
            
            element.addEventListener('mousedown', function(e) {
                draggedElement = this;
                const rect = this.getBoundingClientRect();
                const parent = this.parentElement.getBoundingClientRect();
                offsetX = e.clientX - rect.left;
                offsetY = e.clientY - rect.top;
                this.style.cursor = 'grabbing';
            });
        });

        document.addEventListener('mousemove', function(e) {
            if (draggedElement) {
                const parent = document.getElementById('chequePreview').getBoundingClientRect();
                let newLeft = e.clientX - parent.left - offsetX;
                let newTop = e.clientY - parent.top - offsetY;
                
                draggedElement.style.left = newLeft + 'px';
                draggedElement.style.top = newTop + 'px';
                draggedElement.style.right = 'auto';
                
                if (draggedElement === selectedElement) {
                    document.getElementById('propX').value = Math.round(newLeft);
                    document.getElementById('propY').value = Math.round(newTop);
                }
            }
        });

        document.addEventListener('mouseup', function() {
            if (draggedElement) {
                draggedElement.style.cursor = 'move';
                savePositions();
                draggedElement = null;
            }
        });

        document.getElementById('chequeNumber').addEventListener('input', function(e) {
            saveData();
        });

        document.getElementById('dateInput').addEventListener('change', function(e) {
            displayDateWithSpaces(e.target.value);
            saveData();
        });

        document.getElementById('payeeInput').addEventListener('input', function(e) {
            document.getElementById('payeeDisplay').textContent = e.target.value || '<‡∏™‡∏±‡πà‡∏á‡∏à‡πà‡∏≤‡∏¢>';
            saveData();
        });

        document.getElementById('amountInput').addEventListener('input', function(e) {
            const amount = parseAmount(e.target.value);
            document.getElementById('amountText').textContent = numberToThaiText(amount);
            document.getElementById('amountNumber').textContent = `***${fmtBaht.format(amount)}***`;
            saveData();
        });

        document.getElementById('showAcPayee').addEventListener('change', function(e) {
            document.getElementById('acPayee').style.display = e.target.checked ? 'block' : 'none';
            saveData();
        });

        document.getElementById('showLine').addEventListener('change', function(e) {
            document.getElementById('lineHolder').style.display = e.target.checked ? 'block' : 'none';
            saveData();
        });

        function savePositions() {
            const positions = {};
            document.querySelectorAll('.draggable').forEach(element => {
                positions[element.id] = {
                    top: element.style.top,
                    left: element.style.left,
                    right: element.style.right,
                    fontSize: element.style.fontSize,
                    color: element.style.color,
                    fontWeight: element.style.fontWeight
                };
            });
            localStorage.setItem('chequePositions', JSON.stringify(positions));
        }

        function loadPositions() {
            const saved = localStorage.getItem('chequePositions');
            if (saved) {
                const positions = JSON.parse(saved);
                Object.keys(positions).forEach(id => {
                    const element = document.getElementById(id);
                    if (element && positions[id]) {
                        if (positions[id].top) element.style.top = positions[id].top;
                        if (positions[id].left) element.style.left = positions[id].left;
                        if (positions[id].right) element.style.right = positions[id].right;
                        if (positions[id].fontSize) element.style.fontSize = positions[id].fontSize;
                        if (positions[id].color) element.style.color = positions[id].color;
                        if (positions[id].fontWeight) element.style.fontWeight = positions[id].fontWeight;
                    }
                });
            }
        }

        function saveData() {
            const data = {
                branch: document.getElementById('branchInput')?.value || '',
                bank: document.getElementById('bankSelect').value,
                chequeNumber: document.getElementById('chequeNumber').value,
                date: document.getElementById('dateInput').value,
                payee: document.getElementById('payeeInput').value,
                amount: document.getElementById('amountInput').value,
                showAcPayee: document.getElementById('showAcPayee').checked,
                showLine: document.getElementById('showLine').checked
            };
            localStorage.setItem('chequeData', JSON.stringify(data));
        }

        function loadData() {
            const saved = localStorage.getItem('chequeData');
            if (saved) {
                const data = JSON.parse(saved);
                
                // ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏Ç‡∏≤
                if (document.getElementById('branchInput')) {
                    document.getElementById('branchInput').value = data.branch || '';
                }
                
                document.getElementById('bankSelect').value = data.bank || 'custom';
                document.getElementById('chequeNumber').value = data.chequeNumber || '';
                document.getElementById('dateInput').value = data.date || '';
                document.getElementById('payeeInput').value = data.payee || '';
                document.getElementById('amountInput').value = data.amount || '';
                document.getElementById('showAcPayee').checked = data.showAcPayee !== false;
                document.getElementById('showLine').checked = data.showLine !== false;
                
                displayDateWithSpaces(data.date);
                document.getElementById('payeeDisplay').textContent = data.payee || '<‡∏™‡∏±‡πà‡∏á‡∏à‡πà‡∏≤‡∏¢>';
                const amount = parseAmount(data.amount) || 0;
                document.getElementById('amountText').textContent = numberToThaiText(amount);
                document.getElementById('amountNumber').textContent = `***${fmtBaht.format(amount)}***`;
                document.getElementById('acPayee').style.display = data.showAcPayee !== false ? 'block' : 'none';
                document.getElementById('lineHolder').style.display = data.showLine !== false ? 'block' : 'none';
            }
            
            const paperSize = localStorage.getItem('paperSize');
            if (paperSize) {
                const preview = document.getElementById('chequePreview');
                const [width, height] = paperSize.split('x');
                preview.style.width = width + 'px';
                preview.style.height = height + 'px';
            } else {
                document.getElementById('chequePreview').style.width = '800px';
                document.getElementById('chequePreview').style.height = '350px';
            }
        }

        async function printCheque() {
            const branch = document.getElementById('branchInput').value;
            const chequeNum = document.getElementById('chequeNumber').value;
            const date = document.getElementById('dateInput').value;
            const payee = document.getElementById('payeeInput').value;
            const amount = document.getElementById('amountInput').value;
            const bank = document.getElementById('bankSelect').value;

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤
            if (!branch) {
                Swal.fire({
                    title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤!',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏ä‡πá‡∏Ñ',
                    icon: 'warning',
                    confirmButtonColor: '#ff9800'
                });
                return;
            }

            if (!chequeNum || !date || !payee || !amount) {
                Swal.fire({
                    title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô!',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á',
                    icon: 'warning',
                    confirmButtonColor: '#ff9800'
                });
                return;
            }

            await saveChequeRecord({
                branch: branch, // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤
                bank: bank,
                chequeNumber: chequeNum,
                date: date,
                payee: payee,
                amount: parseAmount(amount),
                printedAt: new Date().toISOString()
            });

            // ‡∏ñ‡πâ‡∏≤‡∏£‡∏±‡∏ô‡πÉ‡∏ô Electron
            if (window.electronAPI) {
                const result = await window.electronAPI.printCheque({
                    silent: true,
                    printBackground: true,
                    color: true
                });
                
                if (result.success) {
                    
                    Swal.fire({
                        title: '‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                        text: '‡πÄ‡∏ä‡πá‡∏Ñ‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡πâ‡∏ß',
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                } else {
                    Swal.fire({
                        title: '‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                        text: result.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                        icon: 'error'
                    });
                }
            } else {
                // Browser ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤
                window.print();
                clearFormwithnoConfirm();   
                setTimeout(() => {
                    Swal.fire({
                        title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß!',
                        text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô',
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                }, 500);
            }

            setLastForBranch(branch, chequeNum);                 // ‡πÄ‡∏Å‡πá‡∏ö "‡πÄ‡∏•‡∏Ç‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î" ‡∏Ç‡∏≠‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏µ‡πâ
            const nextNo = incChequeStr(chequeNum) || '';       // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏•‡∏Ç‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
            if (nextNo) {
                document.getElementById('chequeNumber').value = nextNo;
                saveData();
            }
        }

        document.getElementById('branchInput').addEventListener('change', async function () {
            const branch = this.value;
            if (!branch) return;

            // 1) ‡∏î‡∏π‡πÄ‡∏•‡∏Ç‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏µ‡πâ‡∏à‡∏≤‡∏Å localStorage
            const last = getLastForBranch(branch);

            // 2) ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ last -> ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏Ç‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏à‡∏≤‡∏Å last
            //    ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ -> ‡∏•‡∏≠‡∏á‡∏Ç‡∏≠‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡πá‡πÄ‡∏ß‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏™‡πà‡πÄ‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å)
            let nextNo = last ? incChequeStr(last) : await fetchNextFromServer(branch);

            if (nextNo) {
                document.getElementById('chequeNumber').value = nextNo;
                saveData();
            }
        });

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏™‡∏°‡∏≠ 
        const LAST_KEY = 'lastChequeNoByBranch';

        function getLastMap() {
            try { return JSON.parse(localStorage.getItem(LAST_KEY) || '{}'); }
            catch { return {}; }
        }

        function getLastForBranch(branch) {
            return branch ? (getLastMap()[branch] || '') : '';
        }

        function setLastForBranch(branch, no) {
            if (!branch || !no) return;
            const m = getLastMap();
            m[branch] = no;
            localStorage.setItem(LAST_KEY, JSON.stringify(m));
        }

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏•‡∏Ç‡πÇ‡∏î‡∏¢‡∏Ñ‡∏á prefix/suffix ‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢
        function incChequeStr(s) {
            if (!s) return s;
            const m = s.match(/^(.*?)(\d+)([^0-9]*)$/);
            if (!m) return s; // ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏•‡∏Ç‡∏ó‡πâ‡∏≤‡∏¢ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°
            const [, prefix, num, suffix] = m;
            const width = num.length;
            const next = (BigInt(num) + 1n).toString().padStart(width, '0');
            return prefix + next + suffix;
        }

        // ‡∏•‡∏≠‡∏á‡∏Ç‡∏≠ "‡πÄ‡∏•‡∏Ç‡∏ñ‡∏±‡∏î‡πÑ‡∏õ" ‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå (‡∏°‡∏µ/‡πÑ‡∏°‡πà‡∏°‡∏µ ‡∏Å‡πá‡πÑ‡∏î‡πâ)
        async function fetchNextFromServer(branch, bank='') {
            if (!branch) return '';
            try {
                const q = new URLSearchParams({ branch, bank });
                const res = await fetch(`${API_BASE}/cheques/next?` + q.toString());
                if (!res.ok) return '';
                const js = await res.json();
                // ‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏™‡πà‡∏á next ‡∏°‡∏≤‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∑‡∏ô ''
                return js?.next || '';
            } catch {
                return '';
            }
        }

        function useNextChequeNo() {
            const branch = document.getElementById('branchInput').value || '';
            const current = document.getElementById('chequeNumber').value || getLastForBranch(branch) || '';
            const nextNo = current ? incChequeStr(current) : '';
            if (nextNo) {
                document.getElementById('chequeNumber').value = nextNo;
                saveData();
            }
        }

        async function saveChequeRecord(record) {
            try {
                await fetch(`${API_BASE}/cheques`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        branch_code: record.branch,
                        bank: record.bank,
                        cheque_number: record.chequeNumber,
                        date: record.date,
                        payee: record.payee,
                        amount: record.amount
                    })
                });
            } catch (e) {
                Swal.fire({ icon: 'error', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ä‡πá‡∏Ñ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡πÑ‡∏î‡πâ' });
            }
        }

        async function loadReport() {
            const container = document.getElementById('reportContainer');
            let records = [];
            try {
                const res = await fetch(`${API_BASE}/cheques`);
                records = await res.json();
            } catch (e) {
                container.innerHTML = '<div class="no-data">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ</div>';
                return;
            }
            if (records.length === 0) {
                container.innerHTML = '<div class="no-data">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏ä‡πá‡∏Ñ</div>';
                return;
            }
            let html = '<table class="report-table"><thead><tr>';
            html += '<th>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</th><th>‡πÄ‡∏•‡∏Ç‡πÄ‡∏ä‡πá‡∏Ñ</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏´‡πâ</th>';
            html += '<th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå</th>';
            html += '</tr></thead><tbody>';
            records.forEach((record) => {
                const bankName = record.bank === 'custom' ? '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á' : 
                                 record.bank === 'scb' ? 'SCB' :
                                 record.bank === 'kbank' ? 'KBANK' :
                                 record.bank === 'ktb' ? 'KTB' : record.bank;
                html += '<tr>';
                html += `<td>${bankName}</td>`;
                html += `<td>${record.cheque_number}</td>`;
                html += `<td>${formatDateDisplay(record.date)}</td>`;
                html += `<td>${record.payee}</td>`;
                html += `<td>${record.amount.toFixed(2)}</td>`;
                html += `<td>${record.printed_at ? new Date(record.printed_at).toLocaleString('th-TH') : ''}</td>`;
                html += `<td></td>`;
                html += '</tr>';
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function deleteChequeRecord(index) {
            Swal.fire({
                title: '‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?',
                text: '‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#f44336',
                cancelButtonColor: '#999',
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡πÄ‡∏•‡∏¢',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then((result) => {
                if (result.isConfirmed) {
                    let records = JSON.parse(localStorage.getItem('chequeRecords') || '[]');
                    records.splice(index, 1);
                    localStorage.setItem('chequeRecords', JSON.stringify(records));
                    loadReport();
                    if (typeof loadReportLarge === 'function') {
                        loadReportLarge();
                    }
                    
                    Swal.fire({
                        title: '‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß!',
                        text: '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢',
                        icon: 'success',
                        timer: 1500,
                        showConfirmButton: false
                    });
                }
            });
        }

        document.getElementById('dateInput').value = new Date().toISOString().split('T')[0];

        displayDateWithSpaces(document.getElementById('dateInput').value);

        window.addEventListener('load', function() {
            loadPositions();
            loadData();
        });

        // ==================== Accordion Menu ====================
        function toggleMenu(menuId) {
            const header = document.getElementById(menuId + 'Header');
            const content = document.getElementById(menuId + 'Content');
            
            // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏°‡∏ô‡∏π‡πÑ‡∏°‡πà‡∏°‡∏µ content (‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô, ‡∏™‡∏≤‡∏Ç‡∏≤, ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤)
            if (!content) {
                // ‡∏õ‡∏¥‡∏î active ‡∏Ç‡∏≠‡∏á‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                document.querySelectorAll('.menu-header').forEach(h => {
                    if (h.id !== 'inputHeader') {
                        h.classList.remove('active');
                    }
                });
                
                // ‡∏õ‡∏¥‡∏î content ‡∏Ç‡∏≠‡∏á‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ
                document.querySelectorAll('.menu-content').forEach(menu => {
                    if (menu.id !== 'inputContent') {
                        menu.classList.remove('active');
                    }
                });
                
                // Toggle active ‡∏Ç‡∏≠‡∏á‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡∏¥‡∏Å
                if (header.classList.contains('active')) {
                    header.classList.remove('active');
                    switchToInput();
                } else {
                    header.classList.add('active');
                    
                    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡πÄ‡∏°‡∏ô‡∏π
                    if (menuId === 'report') {
                        switchToReport();
                    } else if (menuId === 'branch') {
                        switchToBranch();
                    } else if (menuId === 'settings') {
                        switchToSettings();
                    }
                }
                return;
            }
            
            // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡∏°‡∏µ content (‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö)
            document.querySelectorAll('.menu-content').forEach(menu => {
                if (menu.id !== menuId + 'Content' && menu.id !== 'inputContent') {
                    menu.classList.remove('active');
                    const menuHeader = menu.previousElementSibling;
                    if (menuHeader) {
                        menuHeader.classList.remove('active');
                    }
                }
            });
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                header.classList.remove('active');
            } else {
                content.classList.add('active');
                header.classList.add('active');
            }
        }

        function switchToBranch() {
            document.getElementById('chequeWorkspace').style.display = 'none';
            document.getElementById('reportWorkspace').style.display = 'none';
            document.getElementById('settingsWorkspace').style.display = 'none';
            document.getElementById('branchWorkspace').style.display = 'block';
            loadBranches2();
        }

        function switchToSettings() {
            document.getElementById('chequeWorkspace').style.display = 'none';
            document.getElementById('reportWorkspace').style.display = 'none';
            document.getElementById('branchWorkspace').style.display = 'none';
            document.getElementById('settingsWorkspace').style.display = 'block';
            updateSystemInfo2();
        }

        // function switchToReport() {
        //     document.getElementById('chequeWorkspace').style.display = 'none';
        //     const reportWork = document.getElementById('reportWorkspace');
        //     if (reportWork) {
        //         reportWork.style.display = 'block';
        //         loadReportWithWeekly();
        //     }
        // }

        // function switchToInput() {
        //     document.getElementById('chequeWorkspace').style.display = 'block';
        //     const reportWork = document.getElementById('reportWorkspace');
        //     if (reportWork) {
        //         reportWork.style.display = 'none';
        //     }
        // }

        function switchToInput() {
            document.getElementById('chequeWorkspace').style.display = 'block';
            document.getElementById('reportWorkspace').style.display = 'none';
            document.getElementById('branchWorkspace').style.display = 'none';
            document.getElementById('settingsWorkspace').style.display = 'none';
        }

        function switchToReport() {
            document.getElementById('chequeWorkspace').style.display = 'none';
            document.getElementById('branchWorkspace').style.display = 'none';
            document.getElementById('settingsWorkspace').style.display = 'none';
            document.getElementById('reportWorkspace').style.display = 'block';
            loadReportWithWeekly();
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
        function clearForm() {
            Swal.fire({
                title: '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?',
                text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#00bcd4',
                cancelButtonColor: '#d33',
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then((result) => {
                if (result.isConfirmed) {
                    // ‡πÑ‡∏°‡πà‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏≤‡∏Ç‡∏≤ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≤‡∏Ç‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                    const currentBranch = localStorage.getItem('currentBranch');
                    if (currentBranch) {
                        document.getElementById('branchInput').value = currentBranch;
                    }
                    
                    document.getElementById('chequeNumber').value = '';
                    document.getElementById('dateInput').value = new Date().toISOString().split('T')[0];
                    document.getElementById('payeeInput').value = '';
                    document.getElementById('amountInput').value = '';
                    
                    displayDateWithSpaces(document.getElementById('dateInput').value);
                    document.getElementById('payeeDisplay').textContent = '<‡∏™‡∏±‡πà‡∏á‡∏à‡πà‡∏≤‡∏¢>';
                    document.getElementById('amountText').textContent = '';
                    document.getElementById('amountNumber').textContent = '***0.00***';
                    
                    saveData();
                    
                    Swal.fire({
                        title: '‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß!',
                        text: '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà',
                        icon: 'success',
                        timer: 1500,
                        showConfirmButton: false
                    });
                }
            });
        }

        function clearFormwithnoConfirm() {
            const currentBranch = localStorage.getItem('currentBranch');
            if (currentBranch) {
                document.getElementById('branchInput').value = currentBranch;
            }
            document.getElementById('chequeNumber').value = '';
            document.getElementById('dateInput').value = new Date().toISOString().split('T')[0];
            document.getElementById('payeeInput').value = '';
            document.getElementById('amountInput').value = '';
            
            displayDateWithSpaces(document.getElementById('dateInput').value);
            document.getElementById('payeeDisplay').textContent = '<‡∏™‡∏±‡πà‡∏á‡∏à‡πà‡∏≤‡∏¢>';
            document.getElementById('amountText').textContent = '';
            document.getElementById('amountNumber').textContent = '***0.00***';
            
            saveData();
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Autocomplete ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô
        function debounce(fn, delay=200){
            let t; 
            return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), delay); };
        }
        
        function setupAutocompletePayee() {
            const input = document.getElementById('payeeInput');
            const list  = document.getElementById('autocomplete-list');
            const branchSelect = document.getElementById('branchInput');

            async function fetchPayees(q) {
                const params = new URLSearchParams();
                if (q) params.set('q', q);
                params.set('limit', '10');
                const branch = branchSelect?.value || localStorage.getItem('currentBranch') || '';
                if (branch) params.set('branch', branch);

                const res = await fetch(`${API_BASE}/payees?` + params.toString());
                if (!res.ok) return [];
                return await res.json(); // array of strings
            }

            const render = (items) => {
                list.innerHTML = '';
                if (!items.length) { list.style.display='none'; return; }
                items.forEach(name=>{
                    const div = document.createElement('div');
                    div.textContent = name;
                    div.addEventListener('click', ()=>{
                        input.value = name;
                        list.innerHTML = '';
                        list.style.display='none';
                        document.getElementById('payeeDisplay').textContent = name;
                        saveData();
                        // ‡πÄ‡∏Å‡πá‡∏ö recent payees ‡∏ù‡∏±‡πà‡∏á client ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (optional)
                        try {
                            const recent = JSON.parse(localStorage.getItem('recentPayees')||'[]');
                            if (!recent.includes(name)) {
                                recent.unshift(name);
                                localStorage.setItem('recentPayees', JSON.stringify(recent.slice(0,30)));
                            }
                        } catch(e){}
                    });
                list.appendChild(div);
                });
                list.style.display='block';
            };
            const onInput = debounce(async ()=>{
            const q = (input.value || '').trim();
            if (!q) { list.innerHTML=''; list.style.display='none'; return; }

            // ‡∏•‡∏≠‡∏á‡∏ú‡∏™‡∏° recent payees (client) ‡∏Å‡∏±‡∏ö‡∏ú‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∑‡πà‡∏ô
            let merged = [];
            try {
            const [server, recent] = await Promise.all([
                fetchPayees(q),
                Promise.resolve(JSON.parse(localStorage.getItem('recentPayees')||'[]'))
            ]);
            const recFiltered = (recent||[]).filter(r => r.toLowerCase().includes(q.toLowerCase()));
            const set = new Set();
            [...recFiltered, ...server].forEach(v => { if (v && !set.has(v)) { set.add(v); merged.push(v);} });
            merged = merged.slice(0, 10);
            } catch(e) { merged = []; }

            render(merged);
        }, 250);

        input.addEventListener('input', onInput);
        document.addEventListener('click', (e)=>{
            if (e.target !== input) { list.innerHTML=''; list.style.display='none'; }
        });
        }



        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πá‡∏Ñ
        function loadChequeByNumber() {
            const chequeNum = document.getElementById('chequeNumber').value;
            if (!chequeNum) return;
            
            const records = JSON.parse(localStorage.getItem('chequeRecords') || '[]');
            const existing = records.find(r => r.chequeNumber === chequeNum);
            
            if (existing) {
                // ‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤
                const branches = JSON.parse(localStorage.getItem('branches') || '[]');
                const branchInfo = branches.find(b => b.code === existing.branch);
                const branchName = branchInfo ? `${branchInfo.code} - ${branchInfo.name}` : existing.branch;
                
                Swal.fire({
                    title: '‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏î‡∏¥‡∏°!',
                    html: `
                        <div style="text-align: left; padding: 10px;">
                            <p><strong>‡∏™‡∏≤‡∏Ç‡∏≤:</strong> ${branchName}</p>
                            <p><strong>‡πÄ‡∏•‡∏Ç‡πÄ‡∏ä‡πá‡∏Ñ:</strong> ${existing.chequeNumber}</p>
                            <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${formatDateDisplay(existing.date)}</p>
                            <p><strong>‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏´‡πâ:</strong> ${existing.payee}</p>
                            <p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô:</strong> ${fmtBaht.format(existing.amount)} ‡∏ö‡∏≤‡∏ó</p>
                        </div>
                    `,
                    icon: 'info',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ',
                    cancelButtonText: '‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ'
                }).then((result) => {
                    if (result.isConfirmed) {
                        document.getElementById('branchInput').value = existing.branch || '';
                        document.getElementById('bankSelect').value = existing.bank || 'custom';
                        document.getElementById('dateInput').value = existing.date;
                        document.getElementById('payeeInput').value = existing.payee;
                        document.getElementById('amountInput').value = existing.amount.toString();
                        
                        displayDateWithSpaces(existing.date);
                        document.getElementById('payeeDisplay').textContent = existing.payee;
                        const amount = parseAmount(existing.amount);
                        document.getElementById('amountText').textContent = numberToThaiText(amount);
                        document.getElementById('amountNumber').textContent = `***${fmtBaht.format(amount)}***`;
                        
                        saveData();
                        
                        Swal.fire({
                            title: '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß!',
                            icon: 'success',
                            timer: 1500,
                            showConfirmButton: false
                        });
                    }
                });
            }
        }

        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        async function fetchCheques() {
            const res = await fetch(`${API_BASE}/cheques`);
            return await res.json();
        }

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ä‡πá‡∏Ñ‡πÉ‡∏´‡∏°‡πà
        async function saveCheque(cheque) {
            await fetch(`${API_BASE}/cheques`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(cheque)
            });
        }

        async function loadBranches() {
            let branches = [];
            try {
                const res = await fetch(`${API_BASE}/branches`);
                branches = await res.json();
            } catch (e) {
                // fallback: ‡∏ß‡πà‡∏≤‡∏á
            }
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï dropdown ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏≤‡∏Ç‡∏≤
            const branchSelect = document.getElementById('currentBranch');
            if (branchSelect) {
                branchSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ --</option>';
                branches.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch.code;
                    option.textContent = `${branch.code} - ${branch.name}`;
                    branchSelect.appendChild(option);
                });
            }
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï dropdown ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏ä‡πá‡∏Ñ
            const branchInput = document.getElementById('branchInput');
            if (branchInput) {
                branchInput.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ --</option>';
                branches.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch.code;
                    option.textContent = `${branch.code} - ${branch.name}`;
                    branchInput.appendChild(option);
                });
            }
            // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏Ç‡∏≤ (‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏Ç‡∏≤)
            const list = document.getElementById('branchList');
            if (list) {
                if (branches.length === 0) {
                    list.innerHTML = '<div class="no-data">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏≤‡∏Ç‡∏≤</div>';
                } else {
                    let html = '<div style="padding: 10px;">';
                    branches.forEach((branch) => {
                        html += `
                            <div style="padding: 10px; margin-bottom: 10px; background: #f9f9f9; border-radius: 5px; border-left: 4px solid #ddd;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>${branch.code}</strong> - ${branch.name}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    list.innerHTML = html;
                }
            }
        }

        async function addBranch() {
            const code = document.getElementById('newBranchCode').value.trim();
            const name = document.getElementById('newBranchName').value.trim();
            if (!code || !name) {
                Swal.fire({
                    title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•!',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤',
                    icon: 'warning'
                });
                return;
            }
            try {
                await fetch(`${API_BASE}/branches`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, name })
                });
            } catch (e) {
                Swal.fire({
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡πÑ‡∏î‡πâ',
                    icon: 'error'
                });
                return;
            }
            document.getElementById('newBranchCode').value = '';
            document.getElementById('newBranchName').value = '';
            await loadBranches();
            Swal.fire({
                title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                text: `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤ ${code} - ${name} ‡πÅ‡∏•‡πâ‡∏ß`,
                icon: 'success',
                timer: 1500,
                showConfirmButton: false
            });
        }

        function changeBranch() {
            const branchCode = document.getElementById('currentBranch').value;
            if (branchCode) {
                localStorage.setItem('currentBranch', branchCode);
                loadBranches();
                Swal.fire({
                    title: '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏•‡πâ‡∏ß!',
                    text: `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤ ${branchCode}`,
                    icon: 'success',
                    timer: 1500,
                    showConfirmButton: false
                });
            }
        }

        async function deleteBranch(code) {
            Swal.fire({
                title: '‡∏•‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤?',
                text: `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤ ${code} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#f44336',
                cancelButtonColor: '#999',
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡πÄ‡∏•‡∏¢',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        await fetch(`${API_BASE}/branches/${code}`, {
                            method: 'DELETE'
                        });
                    } catch (e) {
                        Swal.fire({
                            title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!',
                            text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡πÑ‡∏î‡πâ',
                            icon: 'error'
                        });
                        return;
                    }
                    
                    // ‡∏ñ‡πâ‡∏≤‡∏•‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå
                    if (localStorage.getItem('currentBranch') === code) {
                        localStorage.removeItem('currentBranch');
                    }
                    
                    await loadBranches();
                    await loadBranches2();
                    
                    Swal.fire({
                        title: '‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß!',
                        text: '‡∏™‡∏≤‡∏Ç‡∏≤‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢',
                        icon: 'success',
                        timer: 1500,
                        showConfirmButton: false
                    });
                }
            });
        }

        // ==================== Import/Export ====================

        function exportAllData() {
            const data = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                branches: JSON.parse(localStorage.getItem('branches') || '[]'),
                currentBranch: localStorage.getItem('currentBranch'),
                chequeRecords: JSON.parse(localStorage.getItem('chequeRecords') || '[]'),
                chequePositions: JSON.parse(localStorage.getItem('chequePositions') || '{}'),
                chequeData: JSON.parse(localStorage.getItem('chequeData') || '{}'),
                paperSize: localStorage.getItem('paperSize'),
                templates: {}
            };
            
            // Export templates
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('template_')) {
                    data.templates[key] = localStorage.getItem(key);
                }
            }
            
            downloadJSON(data, `cheque_backup_${new Date().toISOString().split('T')[0]}.json`);
            
            Swal.fire({
                title: '‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß',
                icon: 'success'
            });
        }

        function exportLayoutOnly() {
            const data = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                type: 'layout',
                chequePositions: JSON.parse(localStorage.getItem('chequePositions') || '{}'),
                paperSize: localStorage.getItem('paperSize'),
                templates: {}
            };
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('template_')) {
                    data.templates[key] = localStorage.getItem(key);
                }
            }
            
            downloadJSON(data, `cheque_layout_${new Date().toISOString().split('T')[0]}.json`);
            
            Swal.fire({
                title: '‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Layout ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                icon: 'success'
            });
        }

        function exportRecordsOnly() {
            const data = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                type: 'records',
                branches: JSON.parse(localStorage.getItem('branches') || '[]'),
                chequeRecords: JSON.parse(localStorage.getItem('chequeRecords') || '[]')
            };
            
            downloadJSON(data, `cheque_records_${new Date().toISOString().split('T')[0]}.json`);
            
            Swal.fire({
                title: '‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                text: `‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å ${data.chequeRecords.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`,
                icon: 'success'
            });
        }

        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function handleImport(file) {
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    Swal.fire({
                        title: '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?',
                        html: `
                            <div style="text-align: left; padding: 10px;">
                                <p><strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</strong> ${data.type || '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'}</p>
                                <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å:</strong> ${new Date(data.exportDate).toLocaleString('th-TH')}</p>
                                ${data.chequeRecords ? `<p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ:</strong> ${data.chequeRecords.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>` : ''}
                            </div>
                            <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin-top: 10px;">
                                ‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà!
                            </div>
                        `,
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏•‡∏¢',
                        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            importData(data);
                        }
                    });
                } catch (error) {
                    Swal.fire({
                        title: '‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!',
                        text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå',
                        icon: 'error'
                    });
                }
            };
            reader.readAsText(file);
            
            // Reset input
            document.getElementById('importFile').value = '';
        }

        async function importData(data) {
            try {
                // Import layout ‡∏ú‡πà‡∏≤‡∏ô API
                if (data.type === 'layout' || !data.type) {
                    if (data.templates) {
                        for (const key of Object.keys(data.templates)) {
                            // key: template_{bank}
                            const bank = key.replace('template_', '');
                            let template_json = {};
                            try {
                                template_json = JSON.parse(data.templates[key]);
                            } catch (e) {}
                            await fetch(`${API_BASE}/templates`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ bank, template_json })
                            });
                        }
                    }
                    // chequePositions/paperSize ‡∏¢‡∏±‡∏á‡πÄ‡∏Å‡πá‡∏ö localStorage (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ sync ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡πÅ‡∏à‡πâ‡∏á‡πÑ‡∏î‡πâ)
                    if (data.chequePositions) {
                        localStorage.setItem('chequePositions', JSON.stringify(data.chequePositions));
                    }
                    if (data.paperSize) {
                        localStorage.setItem('paperSize', data.paperSize);
                    }
                }
                // Import branches ‡∏ú‡πà‡∏≤‡∏ô API
                if ((data.type === 'records' || !data.type) && data.branches) {
                    for (const branch of data.branches) {
                        await fetch(`${API_BASE}/branches`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ code: branch.code, name: branch.name })
                        });
                    }
                }
                // Import chequeRecords ‡∏ú‡πà‡∏≤‡∏ô API
                if ((data.type === 'records' || !data.type) && data.chequeRecords) {
                    for (const record of data.chequeRecords) {
                        await fetch(`${API_BASE}/cheques`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                branch_code: record.branch,
                                bank: record.bank,
                                cheque_number: record.chequeNumber,
                                date: record.date,
                                payee: record.payee,
                                amount: record.amount
                            })
                        });
                    }
                }
                // currentBranch, chequeData ‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ localStorage
                if ((data.type === 'records' || !data.type) && data.currentBranch) {
                    localStorage.setItem('currentBranch', data.currentBranch);
                }
                if (!data.type && data.chequeData) {
                    localStorage.setItem('chequeData', JSON.stringify(data.chequeData));
                }
                // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
                loadPositions();
                loadData();
                await loadBranches();
                updateSystemInfo();
                Swal.fire({
                    title: '‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                    text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢',
                    icon: 'success'
                }).then(() => {
                    location.reload();
                });
            } catch (error) {
                Swal.fire({
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ',
                    icon: 'error'
                });
            }
        }

        function clearAllData() {
            Swal.fire({
                title: '‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?',
                html: '<strong style="color: red;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ!</strong>',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#f44336',
                cancelButtonColor: '#999',
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then((result) => {
                if (result.isConfirmed) {
                    localStorage.clear();
                    Swal.fire({
                        title: '‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß!',
                        text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢',
                        icon: 'success'
                    }).then(() => {
                        location.reload();
                    });
                }
            });
        }

        function clearRecordsOnly() {
            Swal.fire({
                title: '‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡πá‡∏Ñ?',
                text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#f44336',
                cancelButtonColor: '#999',
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡πÄ‡∏•‡∏¢',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then((result) => {
                if (result.isConfirmed) {
                    localStorage.removeItem('chequeRecords');
                    loadReport();
                    if (typeof loadReportLarge === 'function') {
                        loadReportLarge();
                    }
                    updateSystemInfo();
                    
                    Swal.fire({
                        title: '‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß!',
                        icon: 'success',
                        timer: 1500,
                        showConfirmButton: false
                    });
                }
            });
        }

        function updateSystemInfo() {
            const records = JSON.parse(localStorage.getItem('chequeRecords') || '[]');
            const branches = JSON.parse(localStorage.getItem('branches') || '[]');
            
            let templateCount = 0;
            for (let i = 0; i < localStorage.length; i++) {
                if (localStorage.key(i).startsWith('template_')) {
                    templateCount++;
                }
            }
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            let dataSize = 0;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                dataSize += key.length + value.length;
            }
            
            document.getElementById('totalCheques').textContent = records.length;
            document.getElementById('totalBranches').textContent = branches.length;
            document.getElementById('totalTemplates').textContent = templateCount;
            document.getElementById('dataSize').textContent = (dataSize / 1024).toFixed(2);
        }

        // ==================== ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå ====================

        function getWeekNumber(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            d.setDate(d.getDate() + 4 - (d.getDay() || 7));
            const yearStart = new Date(d.getFullYear(), 0, 1);
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return { week: weekNo, year: d.getFullYear() };
        }

        function getWeekRange(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            const monday = new Date(d.setDate(diff));
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);
            
            return {
                start: monday,
                end: sunday,
                startStr: formatDateDisplay(monday.toISOString().split('T')[0]),
                endStr: formatDateDisplay(sunday.toISOString().split('T')[0])
            };
        }

        async function loadReportWithWeekly() {
            const container = document.getElementById('reportContainer2') ;
            
            const html = `
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button class="btn-secondary" onclick="backToCheque()" style="margin-bottom: 15px;">
                            ‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏ä‡πá‡∏Ñ
                        </button>
                        <button class="btn-secondary" onclick="showAllRecords()" style="flex: 1;">
                            üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        </button>
                        <button class="btn-info" onclick="showWeeklyReport()" style="flex: 1;">
                            üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå
                        </button>
                        <button class="btn-warning" onclick="showMonthlyReport()" style="flex: 1;">
                            üìÖ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                        </button>
                    </div>
                </div>
                <div id="reportContentDisplay"></div>
            `;
            
            container.innerHTML = html;
            await showAllRecords();
        }

        async function showAllRecords() {
            const container = document.getElementById('reportContentDisplay');
            
            // ‡πÅ‡∏™‡∏î‡∏á Loading
            Swal.fire({
                title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
                html: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà',
                allowOutsideClick: false,
                allowEscapeKey: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö filter
            let branches = [];
            try {
                const branchesRes = await fetch(`${API_BASE}/branches`);
                branches = await branchesRes.json();
            } catch (e) {
                console.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡πÑ‡∏î‡πâ', e);
            }

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            let html = '<h3 style="margin-bottom: 15px;">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>';
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏™‡∏≤‡∏Ç‡∏≤
            if (branches.length > 0) {
                html += `
                    <div style="margin-bottom: 15px; padding: 15px; background: #f9f9f9; border-radius: 5px;">
                        <label style="font-weight: bold; margin-right: 10px;">üîç ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏≤‡∏Ç‡∏≤:</label>
                        <select id="filterBranchDT" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>
                            ${branches.map(b => `<option value="${b.code}">${b.code} - ${b.name}</option>`).join('')}
                        </select>
                    </div>
                `;
            }
            
            html += '<table id="reportTable" class="display" style="width:100%"><thead><tr>';
            html += '<th>‡∏™‡∏≤‡∏Ç‡∏≤</th><th>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</th><th>‡πÄ‡∏•‡∏Ç‡πÄ‡∏ä‡πá‡∏Ñ</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏´‡πâ</th>';
            html += '<th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>';
            html += '</tr></thead><tbody></tbody></table>';
            
            container.innerHTML = html;
            
            // ‡∏õ‡∏¥‡∏î Loading
            Swal.close();
            
            // Initialize DataTable with server-side processing
            const table = $('#reportTable').DataTable({
                processing: true,
                serverSide: true,
                ajax: {
                    url: `${API_BASE}/cheques`,
                    type: 'GET',
                    dataSrc: 'data'
                },
                columns: [
                    { 
                        data: 'branch_code',
                        render: function(data, type, row) {
                            const branchInfo = branches.find(b => b.code === data);
                            return branchInfo ? branchInfo.code : (data || '-');
                        }
                    },
                    { 
                        data: 'bank',
                        render: function(data) {
                            const bankName = data === 'custom' ? '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á' : 
                                            data === 'scb' ? 'SCB' :
                                            data === 'kbank' ? 'KBANK' :
                                            data === 'ktb' ? 'KTB' : data;
                            return bankName;
                        }
                    },
                    { data: 'cheque_number' },
                    { 
                        data: 'date',
                        render: function(data) {
                            return formatDateDisplay(data);
                        }
                    },
                    { data: 'payee' },
                    { 
                        data: 'amount',
                        render: function(data) {
                            return fmtBaht.format(parseFloat(data || 0));
                        },
                        className: 'dt-right'
                    },
                    { 
                        data: 'printed_at',
                        render: function(data) {
                            return data ? new Date(data).toLocaleString('th-TH') : '-';
                        }
                    },
                    { 
                        data: 'id',
                        orderable: false,
                        searchable: false,
                        render: function(data) {
                            return `
                                <button class="btn-edit" onclick="editChequeFromAPI(${data})" style="padding: 4px 8px; font-size: 12px; margin-right: 5px;">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                <button class="btn-delete" onclick="deleteChequeFromAPI(${data})" style="padding: 4px 8px; font-size: 12px;">‡∏•‡∏ö</button>
                            `;
                        },
                        className: 'dt-center'
                    }
                ],
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/th.json'
                },
                order: [[3, 'desc']], // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô
                pageLength: 50,
                lengthMenu: [[10, 25, 50, 100, 250], [10, 25, 50, 100, 250]],
                dom: 'Blfrtip',
                buttons: ['copy', 'csv', 'excel', 'pdf', 'print']
            });
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏≤‡∏Ç‡∏≤
            if (branches.length > 0) {
                $('#filterBranchDT').on('change', function() {
                    const val = $(this).val();
                    table.column(0).search(val ? '^' + val + '$' : '', true, false).draw();
                });
            }
        }

        async function showWeeklyReport() {
            const container = document.getElementById('reportContentDisplay');
            
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API
            let records = [];
            try {
                const res = await fetch(`${API_BASE}/cheques`);
                records = await res.json();
            } catch (e) {
                container.innerHTML = '<div class="no-data">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API ‡πÑ‡∏î‡πâ</div>';
                return;
            }

            if (records.length === 0) {
                container.innerHTML = '<div class="no-data">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏ä‡πá‡∏Ñ</div>';
                return;
            }

            // ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå
            const weeklyData = {};
            
            records.forEach(record => {
                const weekInfo = getWeekNumber(record.date);
                const weekRange = getWeekRange(record.date);
                const key = `${weekInfo.year}-W${weekInfo.week}`;
                
                if (!weeklyData[key]) {
                    weeklyData[key] = {
                        year: weekInfo.year,
                        week: weekInfo.week,
                        startDate: weekRange.startStr,
                        endDate: weekRange.endStr,
                        records: [],
                        totalAmount: 0,
                        count: 0
                    };
                }
                
                weeklyData[key].records.push(record);
                weeklyData[key].totalAmount += parseFloat(record.amount || 0);
                weeklyData[key].count++;
            });

            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå (‡πÉ‡∏´‡∏°‡πà‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô)
            const sortedWeeks = Object.keys(weeklyData).sort().reverse();

            let html = '<h3 style="margin-bottom: 15px;">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</h3>';
            
            // ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏ß‡∏°
            let grandTotal = 0;
            let grandCount = 0;
            sortedWeeks.forEach(key => {
                grandTotal += weeklyData[key].totalAmount;
                grandCount += weeklyData[key].count;
            });
            
            html += `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h2 style="margin: 0 0 10px 0;">‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</h2>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                        <div>
                            <div style="font-size: 14px; opacity: 0.9;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</div>
                            <div style="font-size: 28px; font-weight: bold;">${sortedWeeks.length}</div>
                        </div>
                        <div>
                            <div style="font-size: 14px; opacity: 0.9;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ</div>
                            <div style="font-size: 28px; font-weight: bold;">${grandCount}</div>
                        </div>
                        <div>
                            <div style="font-size: 14px; opacity: 0.9;">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                            <div style="font-size: 28px; font-weight: bold;">${fmtBaht.format(grandTotal)}</div>
                        </div>
                    </div>
                </div>
            `;

            html += '<table class="report-table"><thead><tr>';
            html += '<th style="width: 80px;">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</th>';
            html += '<th>‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>';
            html += '<th style="width: 100px; text-align: center;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ</th>';
            html += '<th style="width: 150px; text-align: right;">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</th>';
            html += '<th style="width: 100px;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>';
            html += '</tr></thead><tbody>';

            sortedWeeks.forEach(key => {
                const data = weeklyData[key];
                html += '<tr>';
                html += `<td style="text-align: center; font-weight: bold;">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå ${data.week}</td>`;
                html += `<td>${data.startDate} - ${data.endDate}</td>`;
                html += `<td style="text-align: center;">${data.count}</td>`;
                html += `<td style="text-align: right; font-weight: bold; color: #4CAF50;">${fmtBaht.format(data.totalAmount)}</td>`;
                html += `<td style="text-align: center;">`;
                html += `<button class="btn-secondary" style="padding: 5px 10px; font-size: 12px;" onclick="showWeekDetails('${key}')">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>`;
                html += `</td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            
            container.innerHTML = html;
            
            // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô showWeekDetails
            window.weeklyReportData = weeklyData;
        }

        async function showWeekDetails(weekKey) {
            const data = window.weeklyReportData[weekKey];
            
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏≤‡∏Å API
            let branches = [];
            try {
                const res = await fetch(`${API_BASE}/branches`);
                branches = await res.json();
            } catch (e) {}
            
            if (!data) return;
            
            let detailsHtml = `
                <div style="max-height: 500px; overflow-y: auto;">
                    <h4 style="margin-bottom: 10px;">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà ${data.week} (${data.startDate} - ${data.endDate})</h4>
                    <table class="report-table" style="font-size: 13px;">
                        <thead>
                            <tr>
                                <th>‡∏™‡∏≤‡∏Ç‡∏≤</th>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th>‡πÄ‡∏•‡∏Ç‡πÄ‡∏ä‡πá‡∏Ñ</th>
                                <th>‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏´‡πâ</th>
                                <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.records.forEach(record => {
                const branchInfo = branches.find(b => b.code === record.branch_code);
                const branchName = branchInfo ? branchInfo.code : (record.branch_code || '-');
                
                detailsHtml += '<tr>';
                detailsHtml += `<td>${branchName}</td>`;
                detailsHtml += `<td>${formatDateDisplay(record.date)}</td>`;
                detailsHtml += `<td>${record.cheque_number}</td>`;
                detailsHtml += `<td>${record.payee}</td>`;
                detailsHtml += `<td style="text-align: right;">${fmtBaht.format(parseFloat(record.amount || 0))}</td>`;
                detailsHtml += '</tr>';
            });
            
            detailsHtml += `
                        </tbody>
                        <tfoot>
                            <tr style="background: #e3f2fd; font-weight: bold;">
                                <td colspan="4" style="text-align: right;">‡∏£‡∏ß‡∏°:</td>
                                <td style="text-align: right;">${fmtBaht.format(data.totalAmount)}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
            
            Swal.fire({
                title: `‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà ${data.week}`,
                html: detailsHtml,
                width: '900px',
                showCloseButton: true,
                showConfirmButton: false
            });
        }

        async function showMonthlyReport() {
            const container = document.getElementById('reportContentDisplay');
            
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API
            let records = [];
            try {
                const res = await fetch(`${API_BASE}/cheques`);
                records = await res.json();
            } catch (e) {
                container.innerHTML = '<div class="no-data">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API ‡πÑ‡∏î‡πâ</div>';
                return;
            }

            if (records.length === 0) {
                container.innerHTML = '<div class="no-data">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏ä‡πá‡∏Ñ</div>';
                return;
            }

            // ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
            const monthlyData = {};
            const thaiMonths = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];
            
            records.forEach(record => {
                const date = new Date(record.date);
                const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                if (!monthlyData[key]) {
                    monthlyData[key] = {
                        year: date.getFullYear(),
                        month: date.getMonth() + 1,
                        monthName: thaiMonths[date.getMonth()],
                        records: [],
                        totalAmount: 0,
                        count: 0
                    };
                }
                
                monthlyData[key].records.push(record);
                monthlyData[key].totalAmount += parseFloat(record.amount || 0);
                monthlyData[key].count++;
            });

            const sortedMonths = Object.keys(monthlyData).sort().reverse();

            let html = '<h3 style="margin-bottom: 15px;">üìÖ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>';
            html += '<table class="report-table"><thead><tr>';
            html += '<th>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ</th>';
            html += '<th style="text-align: center;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ</th>';
            html += '<th style="text-align: right;">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</th>';
            html += '<th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>';
            html += '</tr></thead><tbody>';

            sortedMonths.forEach(key => {
                const data = monthlyData[key];
                html += '<tr>';
                html += `<td style="font-weight: bold;">${data.monthName} ${data.year + 543}</td>`;
                html += `<td style="text-align: center;">${data.count}</td>`;
                html += `<td style="text-align: right; font-weight: bold; color: #4CAF50;">${fmtBaht.format(data.totalAmount)}</td>`;
                html += `<td style="text-align: center;">`;
                html += `<button class="btn-secondary" style="padding: 5px 10px; font-size: 12px;" onclick="showMonthDetails('${key}')">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>`;
                html += `</td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            
            container.innerHTML = html;
            window.monthlyReportData = monthlyData;
        }

        async function showMonthDetails(monthKey) {
            const data = window.monthlyReportData[monthKey];
            
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏≤‡∏Å API
            let branches = [];
            try {
                const res = await fetch(`${API_BASE}/branches`);
                branches = await res.json();
            } catch (e) {}
            
            if (!data) return;
            
            let detailsHtml = `
                <div style="max-height: 500px; overflow-y: auto;">
                    <h4 style="margin-bottom: 10px;">${data.monthName} ${data.year + 543}</h4>
                    <table class="report-table" style="font-size: 13px;">
                        <thead>
                            <tr>
                                <th>‡∏™‡∏≤‡∏Ç‡∏≤</th>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th>‡πÄ‡∏•‡∏Ç‡πÄ‡∏ä‡πá‡∏Ñ</th>
                                <th>‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏´‡πâ</th>
                                <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.records.forEach(record => {
                const branchInfo = branches.find(b => b.code === record.branch_code);
                const branchName = branchInfo ? branchInfo.code : (record.branch_code || '-');
                
                detailsHtml += '<tr>';
                detailsHtml += `<td>${branchName}</td>`;
                detailsHtml += `<td>${formatDateDisplay(record.date)}</td>`;
                detailsHtml += `<td>${record.cheque_number}</td>`;
                detailsHtml += `<td>${record.payee}</td>`;
                detailsHtml += `<td style="text-align: right;">${fmtBaht.format(parseFloat(record.amount || 0))}</td>`;
                detailsHtml += '</tr>';
            });
            
            detailsHtml += `
                        </tbody>
                        <tfoot>
                            <tr style="background: #e3f2fd; font-weight: bold;">
                                <td colspan="4" style="text-align: right;">‡∏£‡∏ß‡∏°:</td>
                                <td style="text-align: right;">${fmtBaht.format(data.totalAmount)}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
            
            Swal.fire({
                title: `${data.monthName} ${data.year + 543}`,
                html: detailsHtml,
                width: '900px',
                showCloseButton: true,
                showConfirmButton: false
            });
        }

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏ä‡πá‡∏Ñ
       function backToCheque() {
            // ‡∏õ‡∏¥‡∏î active ‡∏Ç‡∏≠‡∏á‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡πá‡∏Ñ)
            document.querySelectorAll('.menu-header').forEach(header => {
                if (header.id !== 'inputHeader') {
                    header.classList.remove('active');
                }
            });
            
            document.querySelectorAll('.menu-content').forEach(content => {
                if (content.id !== 'inputContent') {
                    content.classList.remove('active');
                }
            });
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏ä‡πá‡∏Ñ
            switchToInput();
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏Ç‡∏≤ (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà)
        async function loadBranches2() {
            let branches = [];
            try {
                const res = await fetch(`${API_BASE}/branches`);
                branches = await res.json();
            } catch (e) {
                // fallback: ‡∏ß‡πà‡∏≤‡∏á
            }
            
            const branchSelect = document.getElementById('currentBranch2');
            if (branchSelect) {
                branchSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ --</option>';
                branches.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch.code;
                    option.textContent = `${branch.code} - ${branch.name}`;
                    branchSelect.appendChild(option);
                });
                
                const currentBranch = localStorage.getItem('currentBranch');
                if (currentBranch) {
                    branchSelect.value = currentBranch;
                }
            }
            
            const list = document.getElementById('branchList2');
            if (list) {
                const currentBranch = localStorage.getItem('currentBranch');
                if (branches.length === 0) {
                    list.innerHTML = '<div class="no-data">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏≤‡∏Ç‡∏≤</div>';
                } else {
                    let html = '<div style="padding: 10px;">';
                    branches.forEach((branch, index) => {
                        const isCurrent = branch.code === currentBranch;
                        html += `
                            <div style="padding: 10px; margin-bottom: 10px; background: ${isCurrent ? '#e3f2fd' : '#f9f9f9'}; border-radius: 5px; border-left: 4px solid ${isCurrent ? '#2196F3' : '#ddd'};">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>${branch.code}</strong> - ${branch.name}
                                        ${isCurrent ? '<span style="color: #2196F3; font-size: 11px;"> (‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà)</span>' : ''}
                                    </div>
                                    <button class="btn-delete" onclick="deleteBranch('${branch.code}')">‡∏•‡∏ö</button>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    list.innerHTML = html;
                }
            }
        }

        async function addBranch2() {
            const code = document.getElementById('newBranchCode2').value.trim();
            const name = document.getElementById('newBranchName2').value.trim();
            
            if (!code || !name) {
                Swal.fire({
                    title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•!',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤',
                    icon: 'warning'
                });
                return;
            }
            
            try {
                await fetch(`${API_BASE}/branches`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, name })
                });
            } catch (e) {
                Swal.fire({
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡πÑ‡∏î‡πâ',
                    icon: 'error'
                });
                return;
            }
            
            if (!localStorage.getItem('currentBranch')) {
                localStorage.setItem('currentBranch', code);
            }
            
            document.getElementById('newBranchCode2').value = '';
            document.getElementById('newBranchName2').value = '';
            
            await loadBranches();
            await loadBranches2();
            
            Swal.fire({
                title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                text: `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≤‡∏Ç‡∏≤ ${code} - ${name} ‡πÅ‡∏•‡πâ‡∏ß`,
                icon: 'success',
                timer: 1500,
                showConfirmButton: false
            });
        }

        async function changeBranch2() {
            const branchCode = document.getElementById('currentBranch2').value;
            if (branchCode) {
                localStorage.setItem('currentBranch', branchCode);
                await loadBranches();
                await loadBranches2();
                Swal.fire({
                    title: '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏•‡πâ‡∏ß!',
                    text: `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤ ${branchCode}`,
                    icon: 'success',
                    timer: 1500,
                    showConfirmButton: false
                });
            }
        }

        function updateSystemInfo2() {
            const records = JSON.parse(localStorage.getItem('chequeRecords') || '[]');
            const branches = JSON.parse(localStorage.getItem('branches') || '[]');
            
            let templateCount = 0;
            for (let i = 0; i < localStorage.length; i++) {
                if (localStorage.key(i).startsWith('template_')) {
                    templateCount++;
                }
            }
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            let dataSize = 0;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                dataSize += key.length + value.length;
            }
            
            document.getElementById('totalCheques2').textContent = records.length;
            document.getElementById('totalBranches2').textContent = branches.length;
            document.getElementById('totalTemplates2').textContent = templateCount;
            document.getElementById('dataSize2').textContent = (dataSize / 1024).toFixed(2);
        }

        // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÄ‡∏ä‡πá‡∏Ñ
        document.getElementById('chequeNumber').addEventListener('blur', loadChequeByNumber);

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ autocomplete ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
        window.addEventListener('load', function() {
            loadPositions();
            loadData();
            setupAutocompletePayee();
            loadBranches();
            updateSystemInfo();
        });
    </script>
</body>
</html>